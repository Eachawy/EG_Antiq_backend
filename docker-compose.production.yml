# ============================================================================
# Admin Frontend Production Deployment (Independent)
# ============================================================================
# This docker-compose file deploys the Admin Frontend as a standalone service
# with its own NGINX gateway and SSL certificate management.
#
# Domain: admin.kemetra.org
# Ports: 127.0.0.1:8002 (HTTP), 127.0.0.1:8445 (HTTPS)
#
# NOTE: SSL certificates are shared from the main EG_Antiq repository
# ============================================================================

version: '3.8'

services:
  # Admin Frontend (JHipster React SPA)
  admin-frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BACKEND_URL: ${BACKEND_URL:-https://api.kemetra.org}
    container_name: admin-frontend
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      BACKEND_URL: ${BACKEND_URL:-https://api.kemetra.org}
    networks:
      - admin-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # NGINX Gateway
  nginx:
    image: nginx:1.27-alpine
    container_name: admin-nginx
    env_file:
      - .env.production
    ports:
      - '127.0.0.1:8002:80'    # HTTP - localhost only
      - '127.0.0.1:8445:443'   # HTTPS - localhost only
    volumes:
      - ./nginx-configs/admin.kemetra.org.conf:/etc/nginx/conf.d/default.conf:ro
      - ../EG_Antiq/certs:/etc/letsencrypt:ro
      - ../EG_Antiq/certbot-www:/var/www/certbot:ro
    depends_on:
      - admin-frontend
    networks:
      - admin-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost/']
      interval: 30s
      timeout: 3s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Certbot for SSL Certificate Management
  # NOTE: Certbot is managed centrally in EG_Antiq repository
  # This service is kept for documentation but typically not used
  certbot:
    image: certbot/certbot:latest
    container_name: admin-certbot
    volumes:
      - ../EG_Antiq/certs:/etc/letsencrypt
      - ../EG_Antiq/certbot-www:/var/www/certbot
    networks:
      - admin-network
    command: renew --webroot --webroot-path=/var/www/certbot
    profiles:
      - ssl-setup
      - ssl-renew

networks:
  admin-network:
    driver: bridge

# ============================================================================
# Deployment Commands:
# ============================================================================
#
# Initial Setup (First Time):
# 1. Ensure EG_Antiq repository exists at ../EG_Antiq with SSL certificates
#
# 2. Create nginx config directory:
#    mkdir -p nginx-configs
#
# 3. SSL certificates are shared from EG_Antiq repository
#    No separate certificate setup needed
#
# 4. Deploy:
#    docker compose -f docker-compose.production.yml up -d
#
# Regular Deployment:
#   docker compose -f docker-compose.production.yml up -d --build
#
# View Logs:
#   docker compose -f docker-compose.production.yml logs -f admin-frontend
#   docker compose -f docker-compose.production.yml logs -f nginx
#
# SSL Renewal:
#   Handled centrally in EG_Antiq repository
#
# Stop Services:
#   docker compose -f docker-compose.production.yml down
#
# Complete Cleanup:
#   docker compose -f docker-compose.production.yml down -v
# ============================================================================
