# ============================================================================
# Admin Frontend Production Deployment (Independent)
# ============================================================================
# This docker-compose file deploys the Admin Frontend as a standalone service
# with its own NGINX gateway and SSL certificate management.
#
# Domain: admin.kemetra.org
# Ports: 127.0.0.1:8002 (HTTP), 127.0.0.1:8445 (HTTPS)
# ============================================================================

version: '3.8'

services:
  # Admin Frontend (JHipster React SPA)
  admin-frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BACKEND_URL: ${BACKEND_URL:-https://api.kemetra.org}
    container_name: admin-frontend
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      BACKEND_URL: ${BACKEND_URL:-https://api.kemetra.org}
    networks:
      - admin-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          memory: 256M
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # NGINX Gateway
  nginx:
    image: nginx:1.27-alpine
    container_name: admin-nginx
    env_file:
      - .env.production
    ports:
      - '127.0.0.1:8002:80'    # HTTP - localhost only
      - '127.0.0.1:8445:443'   # HTTPS - localhost only
    volumes:
      - ./nginx-configs/admin.kemetra.org.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/letsencrypt:ro
      - ./certbot-www:/var/www/certbot:ro
    depends_on:
      - admin-frontend
    networks:
      - admin-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost/']
      interval: 30s
      timeout: 3s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # Certbot for SSL Certificate Management
  certbot:
    image: certbot/certbot:latest
    container_name: admin-certbot
    volumes:
      - ./certs:/etc/letsencrypt
      - ./certbot-www:/var/www/certbot
    networks:
      - admin-network
    # For initial setup, run:
    # docker compose -f docker-compose.production.yml run --rm certbot \
    #   certonly --webroot --webroot-path=/var/www/certbot \
    #   --email admin@kemetra.org --agree-tos --no-eff-email \
    #   -d admin.kemetra.org
    command: renew --webroot --webroot-path=/var/www/certbot
    profiles:
      - ssl-setup
      - ssl-renew

networks:
  admin-network:
    driver: bridge

# ============================================================================
# Deployment Commands:
# ============================================================================
#
# Initial Setup (First Time):
# 1. Create directories:
#    mkdir -p nginx-configs certs certbot-www
#
# 2. Copy nginx config:
#    # Create nginx-configs/admin.kemetra.org.conf
#
# 3. Setup SSL certificates:
#    docker compose down nginx
#    docker compose --profile ssl-setup run --rm certbot certonly \
#      --standalone -d admin.kemetra.org \
#      --email admin@kemetra.org --agree-tos
#
# 4. Deploy:
#    docker compose up -d
#
# Regular Deployment:
#   docker compose up -d --build
#
# View Logs:
#   docker compose logs -f admin-frontend
#   docker compose logs -f nginx
#
# SSL Renewal (Manual):
#   docker compose --profile ssl-renew run --rm certbot renew
#   docker compose exec nginx nginx -s reload
#
# Stop Services:
#   docker compose down
#
# Complete Cleanup:
#   docker compose down -v
# ============================================================================
